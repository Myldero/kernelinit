# Generated by kernelinit
CC = musl-gcc
CFLAGS = -Wall -Wextra -Wno-unused-function -O0 -static -ggdb -masm=intel -no-pie
RELEASE_CFLAGS = $(CFLAGS) -s

SOURCES = $(wildcard exploit-src/*.c)
OBJECTS = $(SOURCES:.c=.o)
LIBS = -lpthread

kernelsymbols.o:
	gcc -c -g -I. "TEMPLATES_DIR/kernelsymbols.c" -o $@

debug: kernelsymbols.o
	gdb -x debug.gdb

run: cpio
	./my-run.sh

cpio: exploit
	cp CPIOFILE my-rootfs.cpio
	chmod u+s makeroot
	find exploit makeroot | cpio -A -F my-rootfs.cpio -o -H newc --owner=+0.+0
	chmod u-s makeroot
	#sed -i 's/cttyhack setuidgid 1000/cttyhack setuidgid    0/g' my-rootfs.cpio
	#gzip -f my-rootfs.cpio

build: exploit

exploit: $(OBJECTS)
	$(CC) $(CFLAGS) $^ $(LIBS) -o $@

release: $(OBJECTS)
	$(CC) $(RELEASE_CFLAGS) $^ $(LIBS) -o exploit

clean:
	rm -f exploit my-rootfs.cpio my-rootfs.cpio.gz $(OBJECTS)

.PHONY: run debug clean
.DEFAULT_GOAL := run
